<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Settings</title>
        <link rel="stylesheet" href="/css/settings.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
        <style>
            .sidebar ul li.active {
                background-color: #1B5E20;; /* Green highlight */
                color: white;
                font-weight: bold;
            }
        
          
                /* Outer popup box */
                .popup.terms-popup {
                    width: 600px;
                    max-height: 80vh; /* 80% screen */
                    background: white;
                    border-radius: 10px;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden; /* Important! */
                    position: relative;
                }
                
                /* Content inside popup (scrollable area) */
                .popup-content {
                    padding: 20px;
                    overflow-y: auto;
                    flex: 1; /* take all available space */
                }
                
                /* Close button container */
                .close-btn-container {
                    padding: 10px;
                    background-color: #ffffff;
                    border-top: 1px solid #ccc;
                    text-align: center;
                    position: sticky;
                    bottom: 0;
                }
                .cancel-btns {
                    background-color: #1B5E20;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                }
                .cancel-btns:hover {
                    background-color: #145317;
                }  
               
                
        </style>
    </head>
    <body>
        <div class="sidebar">
            <h1> <i class="fas fa-tractor"></i> FarmShare</h1>
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="resources.html"><i class="fas fa-tools"></i> Resources</a></li>
                <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                <li><a href="notifications.html"><i class="fas fa-bell"></i> Notifications</a></li>
                <li class="active"><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                <li id="logout-btn"><a><i class="fas fa-sign-out-alt"></i> Logout</a></li> <!-- Logout stays the same -->
            </ul>
        </div>
        <div class="main-content">
            <section>
                <h2 style="font-size:28px;">Settings</h2>
            </section>

            <!-- settings section -->
            <section class="settings-section">
                <table class="settings-table">
                    <tr onclick="openPopup()">
                        <td><i class="fas fa-key"></i> Change Password</td>
                    </tr>
                    <tr onclick="openTermsPopup()">
                        <td><i class="fas fa-file-contract"></i>Terms and Conditions</td>
                    </tr>
                    <tr onclick="openCustomerCarePopup()">
                        <td><i class="fas fa-phone-alt"></i>Customer Care</td>
                    </tr>
                </table>
                
            </section>
            <!-- terms and conditions -->
            <div class="popup-overlay" id="terms-popup">
                <div class="popup terms-popup">
                    <h2>Terms and Conditions</h2>
                    <div class="popup-content">
                        <p>Here are the terms and conditions of FarmShare. By using this platform, you agree to follow our guidelines regarding fair sharing of agricultural resources...<br></p>
                            <h2>1. Eligibility</h2>
                            <p>You must be at least 18 years old to use our Services. By registering, you represent that you meet this age requirement and have the legal capacity to enter into these Terms.</p>
                        
                            <h2>2. User Accounts</h2>
                            <ul>
                                <li>You must create an account to access certain features.</li>
                                <li>You are responsible for maintaining the confidentiality of your account credentials.</li>
                                <li>You agree to provide accurate and up-to-date information.</li>
                            </ul>
                        
                            <h2>3. Listing and Booking Resources</h2>
                            <ul>
                                <li>Providers must ensure that listed resources are accurate, available, and in good condition.</li>
                                <li>Seekers agree to use the booked resources responsibly and return them in the agreed condition.</li>
                                <li>Bookings are subject to availability and agreement between Providers and Seekers.</li>
                            </ul>
                            <h2>4. User Conduct</h2>
                            <ul>
                                <li>Users must not engage in fraudulent, abusive, or illegal activities on the Platform.</li>
                                <li>Any misuse of the Platform may result in account suspension or termination.</li>
                            </ul>
                        
                            <h2>5. Liability and Disclaimers</h2>
                            <p>The Platform only facilitates connections between Providers and Seekers and is not responsible for the quality, safety, or legality of the resources listed. We are not liable for any loss, damage, or disputes arising from transactions between Users.</p>
                        
                            <h2>6. Intellectual Property</h2>
                            <p>All content and materials on the Platform are owned by or licensed to <strong>FarmShare</strong>. Users may not copy, distribute, or exploit any content without permission.</p>
                        
                            <h2>7. Privacy Policy</h2>
                            <p>Your use of our Services is also governed by our Privacy Policy, which explains how we collect, use, and protect your data.</p>
                        
                            <h2>8. Changes to These Terms</h2>
                            <p>We may update these Terms from time to time. Continued use of the Platform after changes constitutes acceptance of the revised Terms.</p>
                        
                            <h2>9. Governing Law and Dispute Resolution</h2>
                            <p>These Terms are governed by the laws of India. Any disputes shall be resolved through arbitration or in courts located in [Your Jurisdiction].</p>
                            <p>By using our Services, you acknowledge that you have read, understood, and agreed to these Terms.</p>
                    </div>
                    <div class="close-btn-container">
                        <button class="cancel-btns" onclick="closeTermsPopup()">Close</button>
                    </div>
                </div>
            </div>
            <!-- customer care -->
            <div class="popup-overlay" id="customer-care-popup">
                <div class="popup customer-care-popup">
                    <h2>Customer Care</h2>
                    <div class="popup-content">
                        <p>For assistance, contact us at <strong>support@farmshare.com</strong> or call <strong>+9732574350</strong>. Our support team is available 24/7 to help you with any issues.</p>
                    </div>
                    <div class="close-btn-container">
                        <button class="cancel-btns" onclick="closeCustomerCarePopup()">Close</button>
                    </div>
                </div>
            </div>
            <!-- password popup -->
            <div class="popup-overlay" id="popup">
                <div class="popup">
                    <h2>Change Password</h2>
                    <label>Current Password</label>
                    <input type="password" id="current-password">

                    <label>New Password</label>
                    <input type="password" id="new-password">

                    <label>Confirm Password</label>
                    <input type="password" id="confirm-password">

                    <div class="popup-buttons">
                        <button class="cancel-btn" onclick="closePopup()">Cancel</button>
                        <button class="change-btn">Change</button>
                    </div>
                </div>
            </div>
            <!-- Custom Alert Box for Password Change -->
            <div id="custom-alert" class="popup-container">
                <div class="popup">
                    <h2>Success</h2>
                    <p>Your password has changed successfully.</p>
                    <button id="ok-btn">OK</button>
                </div>
            </div>

            <!-- 🚀 Logout Popup -->
            <div id="logout-popup" class="popup-container">
                <div class="popup">
                    <h2>Confirm Logout</h2>
                    <p>Are you sure, you want to log out?</p>
                    <button id="confirm-logout">Yes</button>
                    <button id="cancel-logout">Cancel</button>
                </div>
            </div>

        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // 🚀 Logout Popup Handlers
                document.getElementById("logout-btn").addEventListener("click", function () {
                    document.getElementById("logout-popup").style.display = "flex";
                });
            
                document.getElementById("confirm-logout").addEventListener("click", function () {
                    window.location.href = "index.html";
                });
            
                document.getElementById("cancel-logout").addEventListener("click", function () {
                    document.getElementById("logout-popup").style.display = "none";
                });
            
                // 🔑 Open Password Change Popup
                window.openPopup = function () {
                    document.getElementById("popup").style.display = "flex";
                };
            
                // ❌ Close Password Change Popup
                window.closePopup = function () {
                    document.getElementById("popup").style.display = "none";
                };
            
                document.querySelector(".change-btn").addEventListener("click", async function () {
                    let currentPassword = document.getElementById("current-password").value;
                    let newPassword = document.getElementById("new-password").value;
                    let confirmPassword = document.getElementById("confirm-password").value;
                  
                    if (!currentPassword || !newPassword || !confirmPassword) {
                      alert("Please fill out all fields!");
                      return;
                    }
                  
                    if (newPassword.includes(" ") || confirmPassword.includes(" ")) {
                      alert("Passwords should not contain spaces.");
                      return;
                    }
                  
                    // Validate password strength
                    let passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?#&])[A-Za-z\d@$!%*?#&]{8,}$/;
                    if (!passwordPattern.test(newPassword)) {
                      alert("Password must be at least 8 characters long, with uppercase, lowercase, number, and special character.");
                      return;
                    }
                  
                    if (newPassword !== confirmPassword) {
                      alert("New Password and Confirm Password must match!");
                      return;
                    }
                  
                    // Now make API call
                    const token = localStorage.getItem("token");
                    if (!token) {
                      alert("You must be logged in.");
                      window.location.href = "login.html";
                      return;
                    }
                  
                    try {
                      const res = await fetch("http://localhost:5001/api/users/change-password", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify({
                          currentPassword,
                          newPassword
                        })
                      });
                  
                      const data = await res.json();
                  
                      if (!res.ok) {
                        throw new Error(data.error || "Failed to change password");
                      }
                  
                      // ✅ Password changed!
                      closePopup();
                      document.getElementById("custom-alert").style.display = "flex";
                  
                    } catch (err) {
                      alert(err.message || "Something went wrong. Try again!");
                    }
                  });
                  
                // 🎯 Handle OK Button Click (Logout after password change)
                document.getElementById("ok-btn").addEventListener("click", function () {
                    document.getElementById("custom-alert").style.display = "none"; 
                    localStorage.removeItem("token");  // Clear JWT token
                    window.location.href = "index.html"; // Redirect to login
                });

            });
            function openTermsPopup() {
                document.getElementById("terms-popup").style.display = "flex";
            }
            function closeTermsPopup() {
                document.getElementById("terms-popup").style.display = "none";
            }
            function openCustomerCarePopup() {
                document.getElementById("customer-care-popup").style.display = "flex";
            }
            function closeCustomerCarePopup() {
                document.getElementById("customer-care-popup").style.display = "none";
            }
        </script>
    </body>
</html>